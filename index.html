<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title></title>
<style>
body {
	margin: 2%;
}
#board {
	width: 100%;
	table-layout: fixed; /* don't resize table on text swap */
	border-collapse: collapse;
	text-align: center;
	
	color: #555;
	font-family: Helvetica;
	font-size: 1.5em;
	font-weight: bold;

	background-color: #fdf9f3;
}
#board td {
	border: 2px #ddd solid;
	padding: 2.5%;
}
.piece {
	background-color: green;
}
</style>
</head>
<body> 
<h1>stratego</h1>
<table id="board"></table>

<script>
// https://css-tricks.com/dangers-stopping-event-propagation/
// https://developer.mozilla.org/en-US/docs/Web/API/Event/Comparison_of_Event_Targets
// https://stijndewitt.com/2014/01/26/enums-in-javascript/
// https://davidwalsh.name/event-delegate
// https://developer.mozilla.org/en-US/docs/Web/API/DocumentFragment

// http://www.robert-drummond.com/2015/04/21/event-driven-programming-finite-state-machines-and-nodejs/

function Board() {
	this.empty = null;
	this.board = [
		[this.empty, new Piece('3', Player.ONE), 
			new Piece('3', Player.TWO), this.empty],
		[this.empty, this.empty, this.empty, new Piece('4', Player.TWO)],
		[this.empty, this.empty, this.empty, this.empty],
		[this.empty, new Piece('2', Player.TWO), this.empty, this.empty]
	];
	this.numRows = this.board.length;
	this.numCols = this.board[0].length;

	this.getCell = function (row, col) {
		return this.board[row][col];
	}

	this.setCell = function(piece, row, col) {
		this.board[row][col] = piece;
	}

	// this.cellEmpty = function (row, col) {
	// 	return this.board[row][col] === this.empty;
	// };

	this.cellEmpty = function (cell) {
		return cell === this.empty;
	}

	this.edgeAdjacent = function (p1, p2) {
		var adjacent = (
			(p1.row >= p2.row - 1 && p1.row <= p2.row + 1) && 
			(p1.col >= p2.col - 1 && p1.col <= p2.col + 1));
		var diagonal = (p1.row !== p2.row && p1.col !== p2.col);
		return (adjacent && !diagonal);
	}

	this.swap = function (p1, p2) {
		var piece1 = this.getCell(p1.row, p1.col);
		var piece2 = this.getCell(p2.row, p2.col);
		this.setCell(piece2, p1.row, p1.col);
		this.setCell(piece1, p2.row, p2.col);
	}
}

function Piece(rank, player) {
	this.rank = rank;
	this.player = player;
	this.color = (player === Player.ONE) ? "red" : "blue";
}

function View() {
	this.empty = String.fromCharCode(160);

	this.getBoard = function() {
		return document.getElementById("board");
	}

	this.getCellId = function (row, col) {
		return ["a", row, col].join("-"); // must start with letter
	}

	this.getRowCol = function (cellId) {
		var parts = cellId.split("-");
		var row = parseInt(parts[1]), col = parseInt(parts[2]);
		return {row: row, col: col}
	}

	this.getClick = function(element) {
		if (element.id) { // table cell clicked
			return {cell: element,
				position: this.getRowCol(element.id),
				wrapper: element.childNodes[0]};
		} else { // div clicked
			var cell = element.parentNode;
			return {cell: cell,
				position: this.getRowCol(cell.id),
				wrapper: element};
		}
	}

	this.cellEmpty = function (cell) {
		return cell.textContent === this.empty;
	}

	this.swap = function (e1, e2) {
		var e1Copy = e1.cloneNode(true);
		var e1Parent = e1.parentNode;
		e2.parentNode.insertBefore(e1Copy, e2);
		e1Parent.insertBefore(e2, e1);
		e1Parent.removeChild(e1);
	}

	this.initializeBoard = function(Board, clickHandler) {
		var board = document.createDocumentFragment("");
		for (var i = 0; i < Board.numRows; i++) {
			var row = document.createElement("tr");

			for (var j = 0; j < Board.numCols; j++) {
				var tableCell = document.createElement("td");
				var pieceElement = document.createElement("div");
				var boardPiece = Board.getCell(i, j);
				
				if (Board.cellEmpty(boardPiece)) {
					pieceElement.textContent = this.empty;
				} else {
					pieceElement.textContent = boardPiece.rank;
					var color = Player.properties[boardPiece.player].color;
					pieceElement.style.color = color;
					pieceElement.className += " piece";
				}

				tableCell.id = this.getCellId(i, j);
				tableCell.appendChild(pieceElement);
				row.appendChild(tableCell);
			}
			board.appendChild(row);
		}

		var boardDOM = this.getBoard();
		boardDOM.appendChild(board);
		boardDOM.addEventListener("click", clickHandler);
	}
}

var ClickState = {
	NONE: 0,
	SELECTED: 1,
};

// var PieceState = {
// 	MOVE: 0,
// 	BATTLE: 1,
// }

var Player = {
	ONE: 0,
	TWO: 1,
	properties: {
		0: {color: "red"},
		1: {color: "blue"},
	}
}


function Game(View, Board) {
	var self = this;

	this.View = View;
	this.Board = Board;

	this.previous = null;
	this.state = ClickState.NONE;
	this.currentPlayer = Player.ONE;

	this.start = function() {
		this.View.initializeBoard(this.Board, this.handleClick);

		// clear non-board clicks
		document.addEventListener("click", function (ev) { 
			var boardClicked = ev.defaultPrevented;
			if (!boardClicked) {
				console.log("cleared");
				this.previousSelectedCell = null;
			}
		});
	}

	this.handleClick = function (ev) {
		ev.preventDefault(); // flag event so document won't handle it

		var selected = self.View.getClick(ev.target);
		var selectedPiece = self.Board.getCell(selected.position.row,
			selected.position.col);

		var selfSelected = (selectedPiece) ? 
			selectedPiece.player === self.currentPlayer : false;
		var selectedEmpty = self.Board.cellEmpty(selectedPiece);
		var adjacent = (self.previous) ? 
			self.Board.edgeAdjacent(self.previous.position, 
				selected.position) : false;
		var isCurrentPlayer = (selectedPiece) ? 
			selectedPiece.player === self.currentPlayer : false;

		console.log("state", self.state, "pos", selected.position.row, selected.position.col, "piece", selectedPiece, "empty", selectedEmpty, "own", selfSelected, "adjacent", adjacent);

		switch (self.state) {
			case ClickState.NONE:
				// if valid piece selection, store
				if (!selectedEmpty && isCurrentPlayer) {
					self.previous = selected;
					self.state = ClickState.SELECTED;
				}
				break;
			case ClickState.SELECTED:
				if (adjacent) {
					// move
					if (selectedEmpty) {
						console.log("moving")
						self.View.swap(selected.wrapper, 
							self.previous.wrapper);
						self.Board.swap(selected.position, 
							self.previous.position);
					}
					// battle 
					else if (selectedPiece.player !== self.currentPlayer) {
						console.log("battle");
					}
				}
				self.previousSelectedCell = null;
				self.state = ClickState.NONE;
				break;
			default:
				break;
		}
	}
};


var game = new Game(new View(), new Board());
game.start();
</script>

</body>
</html>
